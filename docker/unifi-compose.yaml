services:
  unifi:
    image: ghcr.io/linuxserver/unifi-network-application:9.0.114
    container_name: unifi
    ports:
      - 3478:3478/udp
      - 10001:10001/udp
      - 8080:8080
    networks:
      - default
      - traefik
    volumes:
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
      - config:/config
    environment:
      PUID: 103
      PGID: 996
      MONGO_USER: unifi
      MONGO_PASS: ${MONGO_PASSWORD}
      MONGO_HOST: unifi-db
      MONGO_PORT: 27017
      MONGO_DBNAME: unifi
      MONGO_AUTHSOURCE: admin
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.services.unifi.loadBalancer.server.port=8443"
      - "traefik.http.routers.unifi-local.entrypoints=http,https"
      - "traefik.http.routers.unifi-local.rule=Host(`unifi.fridge.local`)"

  db:
    image: docker.io/mongo:8.0.4-noble
    container_name: unifi-db
    networks:
      - default
    volumes:
      - data:/data/db
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD}
      MONGO_USER: unifi
      MONGO_PASS: ${MONGO_PASSWORD}
      MONGO_DBNAME: unifi
      MONGO_AUTHSOURCE: admin
    configs:
      - source: init-mongo.sh
        target: /docker-entrypoint-initdb.d/init-mongo.sh
    restart: unless-stopped

configs:
  init-mongo.sh:
    content: |
      #!/bin/bash
      
      if which mongosh > /dev/null 2>&1; then
        mongo_init_bin='mongosh'
      else
        mongo_init_bin='mongo'
      fi
      "${mongo_init_bin}" <<EOF
      use ${MONGO_AUTHSOURCE}
      db.auth("${MONGO_INITDB_ROOT_USERNAME}", "${MONGO_INITDB_ROOT_PASSWORD}")
      db.createUser({
        user: "${MONGO_USER}",
        pwd: "${MONGO_PASS}",
        roles: [
          { db: "${MONGO_DBNAME}", role: "dbOwner" },
          { db: "${MONGO_DBNAME}_stat", role: "dbOwner" }
        ]
      })
      EOF

volumes:
  config:
  data:

networks:
  default:
  traefik:
    name: traefik
    external: true
